#!/usr/bin/env python3
"""
cpend - 查看 Codex 最新回复
"""

import json
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding
setup_windows_encoding()

try:
    from codex_comm import CodexCommunicator
except ImportError as exc:
    print(f"导入失败: {exc}")
    sys.exit(1)


def _load_pending_state() -> dict:
    """从 .codex-session 加载 cask-w 超时时保存的状态"""
    session_file = Path.cwd() / ".codex-session"
    if not session_file.exists():
        return {}
    try:
        with session_file.open("r", encoding="utf-8") as f:
            data = json.load(f)
        return data.get("pending_state", {})
    except Exception:
        return {}


def _clear_pending_state() -> None:
    """清除 pending_state"""
    session_file = Path.cwd() / ".codex-session"
    if not session_file.exists():
        return
    try:
        with session_file.open("r", encoding="utf-8") as f:
            data = json.load(f)
        if "pending_state" in data:
            del data["pending_state"]
            with session_file.open("w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
    except Exception:
        pass


def main() -> int:
    try:
        comm = CodexCommunicator()

        pending = _load_pending_state()
        if pending and pending.get("log_path"):
            state = {
                "log_path": Path(pending["log_path"]),
                "offset": pending.get("offset", 0),
            }
            message, _ = comm.log_reader.try_get_message(state)
            if message:
                _clear_pending_state()
                print(message)
                return 0

        output = comm.consume_pending(display=False)
        if output:
            print(output)
        else:
            print('暂无 Codex 回复')
        return 0
    except Exception as exc:
        print(f"❌ 执行失败: {exc}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
