#!/usr/bin/env python3
"""
opend - View latest OpenCode reply
"""

import json
import os
import sys
from pathlib import Path
import argparse

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding

setup_windows_encoding()

from i18n import t


def _load_session_id_filter(work_dir: Path, explicit_session_file: Path | None) -> str | None:
    """Load OpenCode internal session id (ses_*) from .opencode-session if present."""
    session_file = explicit_session_file
    if session_file is None:
        try:
            from session_utils import find_project_session_file
        except Exception:
            find_project_session_file = None
        session_file = find_project_session_file(work_dir, ".opencode-session") if find_project_session_file else (work_dir / ".opencode-session")

    if session_file and session_file.exists():
        try:
            with session_file.open("r", encoding="utf-8-sig") as f:
                data = json.load(f)
            sid = str(data.get("opencode_session_id") or "").strip()
            if sid.startswith("ses_"):
                return sid
        except Exception:
            pass
    return None


try:
    from cli_output import EXIT_ERROR, EXIT_NO_REPLY, EXIT_OK
    from opencode_comm import OpenCodeLogReader
except ImportError as exc:
    print(f"Import failed: {exc}", file=sys.stderr)
    sys.exit(1)


def _debug_enabled() -> bool:
    return (os.environ.get("CCB_DEBUG") in ("1", "true", "yes")) or (os.environ.get("OPEND_DEBUG") in ("1", "true", "yes"))


def main(argv: list[str]) -> int:
    try:
        parser = argparse.ArgumentParser(prog="opend", add_help=True)
        parser.add_argument("--session-file", dest="session_file", default=None, help="Path to .opencode-session (or .ccb/.opencode-session)")
        args = parser.parse_args(argv[1:])

        from askd_client import resolve_work_dir_with_registry
        from providers import OASK_CLIENT_SPEC

        work_dir, explicit_session_file = resolve_work_dir_with_registry(
            OASK_CLIENT_SPEC,
            provider="opencode",
            cli_session_file=args.session_file,
            env_session_file=os.environ.get("CCB_SESSION_FILE"),
        )

        session_filter = _load_session_id_filter(work_dir, explicit_session_file)
        # Prefer storage-based autodetection for project_id; avoids stale git-derived ids.
        reader = OpenCodeLogReader(project_id="global", work_dir=work_dir, session_id_filter=session_filter)
        message = reader.latest_message()
        if not message:
            print(t("no_reply_available", provider="OpenCode"), file=sys.stderr)
            return EXIT_NO_REPLY
        print(message)
        return EXIT_OK
    except Exception as exc:
        if _debug_enabled():
            import traceback

            traceback.print_exc()
        print(f"[ERROR] {t('execution_failed', error=exc)}", file=sys.stderr)
        return EXIT_ERROR


if __name__ == "__main__":
    sys.exit(main(sys.argv))
