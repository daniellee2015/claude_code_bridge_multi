#!/usr/bin/env python3
"""
ccb-web - CCB Web Controller

Web-based interface for managing CCB services.

Usage:
    ccb-web [--host HOST] [--port PORT] [--generate-token]
"""

import argparse
import sys
import os

# Add lib to path
script_dir = os.path.dirname(os.path.abspath(__file__))
lib_dir = os.path.join(os.path.dirname(script_dir), "lib")
if lib_dir not in sys.path:
    sys.path.insert(0, lib_dir)


def main():
    parser = argparse.ArgumentParser(
        description="CCB Web Controller",
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    parser.add_argument(
        "--host",
        default="127.0.0.1",
        help="Host to bind to (default: 127.0.0.1)",
    )
    parser.add_argument(
        "--port",
        type=int,
        default=8080,
        help="Port to bind to (default: 8080)",
    )
    parser.add_argument(
        "--generate-token",
        action="store_true",
        help="Generate an access token for remote access",
    )
    parser.add_argument(
        "--token",
        help="Use specified token for authentication",
    )

    args = parser.parse_args()

    # Generate token mode
    if args.generate_token:
        from web.app import generate_token
        token = generate_token()
        print(f"Generated access token: {token}")
        print("\nUse this token for remote access:")
        print(f"  curl -H 'Authorization: Bearer {token}' http://host:port/api/...")
        return

    # Check if FastAPI is available
    try:
        import fastapi
        import uvicorn
    except ImportError:
        print("Error: FastAPI and uvicorn are required.")
        print("Install with: pip install fastapi uvicorn[standard]")
        sys.exit(1)

    # Determine if local-only mode
    local_only = args.host in ("127.0.0.1", "localhost", "::1")

    # Create app
    from web.app import create_app
    app = create_app(local_only=local_only, auth_token=args.token)

    # Print startup info
    print(f"CCB Web Controller starting on http://{args.host}:{args.port}")
    if local_only:
        print("Mode: Local only (no authentication required)")
    else:
        if args.token:
            print("Mode: Remote access (token authentication enabled)")
        else:
            print("Warning: Remote access without token - consider using --token")

    # Run server
    uvicorn.run(
        app,
        host=args.host,
        port=args.port,
        log_level="info",
    )


if __name__ == "__main__":
    main()
