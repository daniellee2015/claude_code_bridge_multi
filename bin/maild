#!/usr/bin/env python3
"""
maild - CCB Mail Daemon (v3)

Background service for ASK-based email notifications.

Usage:
    maild start [--foreground]
    maild stop
    maild status
    maild config
    maild test
    maild --help
"""

import argparse
import json
import sys
import os

# Add lib to path
script_dir = os.path.dirname(os.path.abspath(__file__))
project_root = os.path.dirname(script_dir)
lib_dir = os.path.join(project_root, "lib")
if project_root not in sys.path:
    sys.path.insert(0, project_root)
if lib_dir not in sys.path:
    sys.path.insert(0, lib_dir)

from mail.daemon import start_daemon, stop_daemon, get_daemon_status, is_daemon_running
from mail.config import load_config, save_config, SUPPORTED_PROVIDERS


def cmd_start(args):
    """Start the mail daemon."""
    config = load_config()
    if not config.enabled:
        print("Mail service is not enabled.")
        print("Run 'maild setup' or enable via web interface.")
        sys.exit(1)

    if is_daemon_running():
        print("Mail daemon is already running.")
        sys.exit(0)

    print("Starting mail daemon (v3 ASK mode)...")
    start_daemon(foreground=args.foreground)


def cmd_stop(args):
    """Stop the mail daemon."""
    if stop_daemon():
        print("Mail daemon stopped.")
    else:
        sys.exit(1)


def cmd_status(args):
    """Show daemon status."""
    status = get_daemon_status()
    config = load_config()

    print("=" * 50)
    print("CCB Mail Daemon Status")
    print("=" * 50)

    if status.get("running"):
        print(f"Status:  RUNNING")
        print(f"PID:     {status['pid']}")
        print(f"Version: {status.get('version', 3)}")
        print(f"Email:   {status['email']}")
        uptime = status.get("uptime", 0)
        hours = int(uptime // 3600)
        minutes = int((uptime % 3600) // 60)
        print(f"Uptime:  {hours}h {minutes}m")
    else:
        print("Status:  STOPPED")

    print()
    print("Configuration:")
    print(f"  Enabled:      {config.enabled}")

    service_email = ""
    if hasattr(config, 'service_account'):
        service_email = config.service_account.email
    print(f"  Service:      {service_email or '(not configured)'}")

    target_email = getattr(config, 'target_email', '')
    print(f"  Target:       {target_email or '(not configured)'}")

    # V3 specific
    default_provider = getattr(config, 'default_provider', 'claude')
    print(f"  Default:      {default_provider}")


def cmd_config(args):
    """Show configuration."""
    config = load_config()

    print("=" * 50)
    print("CCB Mail Configuration (v3)")
    print("=" * 50)

    print(f"Version:        {config.version}")
    print(f"Enabled:        {config.enabled}")
    print()

    print("Service Account:")
    if hasattr(config, 'service_account'):
        print(f"  Provider:     {config.service_account.provider}")
        print(f"  Email:        {config.service_account.email or '(not set)'}")
        print(f"  IMAP Host:    {config.service_account.imap.host or '(not set)'}")
        print(f"  SMTP Host:    {config.service_account.smtp.host or '(not set)'}")
    print()

    print(f"Target Email:   {getattr(config, 'target_email', '') or '(not set)'}")
    print()

    print("ASK Settings (v3):")
    print(f"  Default Provider: {getattr(config, 'default_provider', 'claude')}")
    print(f"  Default Work Dir: {getattr(config, 'default_work_dir', '') or '(current dir)'}")
    print()

    print("Notification:")
    if hasattr(config, 'notification'):
        print(f"  Prefix:       {config.notification.subject_prefix}")
        print(f"  Max Length:   {config.notification.max_email_length}")
    print()

    print("Polling:")
    print(f"  Interval:     {config.polling.interval_seconds}s")
    print(f"  Folder:       {config.polling.folder}")


def cmd_test(args):
    """Test mail connection."""
    config = load_config()

    service_email = ""
    if hasattr(config, 'service_account'):
        service_email = config.service_account.email

    if not service_email:
        print("Mail not configured. Set service account first.")
        sys.exit(1)

    print(f"Testing connection for {service_email}...")
    print()

    # Test IMAP
    print("IMAP: ", end="", flush=True)
    try:
        from mail.poller import ImapPoller
        poller = ImapPoller(config)
        ok, msg = poller.test_connection()
        print("OK" if ok else f"FAILED - {msg}")
    except Exception as e:
        print(f"ERROR - {e}")

    # Test SMTP
    print("SMTP: ", end="", flush=True)
    try:
        from mail.sender import SmtpSender
        sender = SmtpSender(config)
        ok, msg = sender.test_connection()
        print("OK" if ok else f"FAILED - {msg}")
    except Exception as e:
        print(f"ERROR - {e}")


def cmd_setup(args):
    """Interactive setup wizard."""
    from mail.config import ServiceAccountConfig, PROVIDER_PRESETS
    from mail.credentials import store_password

    config = load_config()

    print("=" * 50)
    print("CCB Mail Setup Wizard")
    print("=" * 50)
    print()

    # Service account
    print("Service Account (CCB's mailbox for sending/receiving)")
    print("-" * 50)

    providers = list(PROVIDER_PRESETS.keys()) + ["custom"]
    print(f"Available providers: {', '.join(providers)}")

    provider = input(f"Provider [{config.service_account.provider}]: ").strip()
    if not provider:
        provider = config.service_account.provider

    email = input(f"Email [{config.service_account.email}]: ").strip()
    if not email:
        email = config.service_account.email

    if provider in PROVIDER_PRESETS:
        config.service_account = ServiceAccountConfig.from_preset(provider, email)
    else:
        config.service_account.provider = provider
        config.service_account.email = email

    password = input("Password/App Password (leave empty to keep existing): ").strip()
    if password:
        store_password(email, password)
        print("Password stored securely.")

    print()

    # Target email
    print("Target Email (your phone's email for notifications)")
    print("-" * 50)

    target = input(f"Target email [{config.target_email}]: ").strip()
    if target:
        config.target_email = target

    print()

    # V3 ASK settings
    print("ASK Settings (v3)")
    print("-" * 50)

    default_provider = getattr(config, 'default_provider', 'claude')
    new_default = input(f"Default provider [{default_provider}]: ").strip().lower()
    if new_default and new_default in SUPPORTED_PROVIDERS:
        config.default_provider = new_default

    default_work_dir = getattr(config, 'default_work_dir', '')
    new_work_dir = input(f"Default work dir [{default_work_dir or '(current)'}]: ").strip()
    if new_work_dir:
        config.default_work_dir = new_work_dir

    print()

    # Enable service
    enable = input("Enable mail service? [Y/n]: ").strip().upper()
    config.enabled = enable != "N"

    # Save
    save_config(config)
    print()
    print("Configuration saved!")
    print()

    if config.enabled:
        print("To start the daemon: maild start")
    else:
        print("Mail service is disabled. Enable with: maild setup")


def main():
    parser = argparse.ArgumentParser(
        description="CCB Mail Daemon (v3)",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Commands:
  start       Start the mail daemon
  stop        Stop the mail daemon
  status      Show daemon status
  config      Show configuration
  test        Test mail connection
  setup       Interactive setup wizard

Examples:
  maild start              # Start daemon in background
  maild start -f           # Start in foreground
  maild test               # Test IMAP/SMTP connection

Email Format:
  Send email with provider prefix in body:
    CLAUDE: fix the bug
    CODEX: analyze this code
""",
    )

    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # start command
    start_parser = subparsers.add_parser("start", help="Start the daemon")
    start_parser.add_argument(
        "--foreground", "-f",
        action="store_true",
        help="Run in foreground (don't daemonize)",
    )
    start_parser.set_defaults(func=cmd_start)

    # stop command
    stop_parser = subparsers.add_parser("stop", help="Stop the daemon")
    stop_parser.set_defaults(func=cmd_stop)

    # status command
    status_parser = subparsers.add_parser("status", help="Show daemon status")
    status_parser.set_defaults(func=cmd_status)

    # config command
    config_parser = subparsers.add_parser("config", help="Show configuration")
    config_parser.set_defaults(func=cmd_config)

    # test command
    test_parser = subparsers.add_parser("test", help="Test mail connection")
    test_parser.set_defaults(func=cmd_test)

    # setup command
    setup_parser = subparsers.add_parser("setup", help="Interactive setup wizard")
    setup_parser.set_defaults(func=cmd_setup)

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    args.func(args)


if __name__ == "__main__":
    main()
