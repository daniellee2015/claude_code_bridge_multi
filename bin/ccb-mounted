#!/usr/bin/env bash
# ccb-mounted - Check which CCB providers are mounted
# Usage: ccb-mounted [--json|--simple]

set -euo pipefail

PROVIDERS="codex:cask gemini:gask opencode:oask claude:lask droid:dask"
CWD=$(pwd)
FORMAT="--json"
AUTOSTART=false

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Argument parsing
while [[ $# -gt 0 ]]; do
  case "$1" in
    --simple)
      FORMAT="--simple"
      shift
      ;;
    --json)
      FORMAT="--json"
      shift
      ;;
    --autostart)
      AUTOSTART=true
      shift
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      CWD="$1"
      shift
      ;;
  esac
done

# Normalize CWD for Windows (convert /e/... to E:/...)
if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
  # Convert msys path /e/foo to E:/foo
  if [[ "$CWD" =~ ^/([a-zA-Z])/ ]]; then
    CWD="${BASH_REMATCH[1]^}:${CWD:2}"
  fi
fi

# Detect OS and get online daemons accordingly
if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "${WINDIR:-}" ]]; then
  # Windows: use ping command to check each provider directly
  MOUNTED=""
  for pair in $PROVIDERS; do
    provider="${pair%%:*}"
    # Check session file exists first
    if [[ -f "$CWD/.ccb/.${provider}-session" ]] || [[ -f "$CWD/.ccb_config/.${provider}-session" ]] || [[ -f "$CWD/.${provider}-session" ]]; then
      # Try the ping command to check if daemon is responsive
      PING_ARGS=("$provider")
      if [[ "$AUTOSTART" == true ]]; then
        PING_ARGS+=("--autostart")
      fi
      if "$SCRIPT_DIR/ccb-ping" "${PING_ARGS[@]}" >/dev/null 2>&1; then
        MOUNTED="$MOUNTED $provider"
      fi
    fi
  done
else
  # Linux/macOS: use pgrep
  ONLINE=$(pgrep -af "bin/[cglod]askd$" 2>/dev/null | grep -oE "[cglod]askd" | sort -u || true)

  MOUNTED=""
  for pair in $PROVIDERS; do
    provider="${pair%%:*}"
    daemon="${pair##*:}"

    # Check session file exists
    if [[ -f "$CWD/.ccb/.${provider}-session" ]] || [[ -f "$CWD/.ccb_config/.${provider}-session" ]] || [[ -f "$CWD/.${provider}-session" ]]; then
      # Check daemon is online
      IS_ONLINE=false
      if echo "$ONLINE" | grep -q "${daemon}d"; then
        IS_ONLINE=true
      fi

      if [[ "$IS_ONLINE" == false ]] && [[ "$AUTOSTART" == true ]]; then
        # Try to autostart if requested and not online
        if "$SCRIPT_DIR/ccb-ping" "$provider" --autostart >/dev/null 2>&1; then
           IS_ONLINE=true
        fi
      fi

      if [[ "$IS_ONLINE" == true ]]; then
        MOUNTED="$MOUNTED $provider"
      fi
    fi
  done
fi

MOUNTED=$(echo $MOUNTED | xargs)  # trim

case "$FORMAT" in
  --simple)
    echo "$MOUNTED"
    ;;
  --json|*)
    if [[ -z "$MOUNTED" ]]; then
      echo "{\"cwd\":\"$CWD\",\"mounted\":[]}"
    else
      JSON_ARRAY=$(echo "$MOUNTED" | sed 's/ /","/g;s/^/"/;s/$/"/')
      echo "{\"cwd\":\"$CWD\",\"mounted\":[$JSON_ARRAY]}"
    fi
    ;;
esac
