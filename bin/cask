#!/usr/bin/env python3
"""
cask - 将消息转发到 Codex 会话
"""
from __future__ import annotations
import json
import os
import sys
from pathlib import Path
from typing import Optional, Tuple

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding
setup_windows_encoding()

from terminal import get_backend_for_session, get_pane_id_from_session


def _usage() -> None:
    print("用法: cask <消息>", file=sys.stderr)


def _load_session() -> Optional[dict]:
    env_session = os.environ.get("CODEX_TMUX_SESSION")
    env_pane = os.environ.get("CODEX_WEZTERM_PANE")
    if env_session or env_pane:
        return {
            "terminal": "wezterm" if env_pane else "tmux",
            "pane_id": env_pane,
            "tmux_session": env_session,
            "runtime_dir": os.environ.get("CODEX_RUNTIME_DIR"),
        }

    session_file = Path.cwd() / ".codex-session"
    if not session_file.exists():
        return None
    try:
        data = json.loads(session_file.read_text(encoding="utf-8"))
        if not data.get("active"):
            return None
        return data
    except Exception:
        return None


def _resolve_session() -> Tuple[dict, str]:
    data = _load_session()
    if not data:
        raise RuntimeError("❌ 未找到 Codex 会话，请先运行 ccb up codex")
    pane_id = get_pane_id_from_session(data)
    if not pane_id:
        raise RuntimeError("❌ 会话配置无效")
    return data, pane_id


def main(argv: list[str]) -> int:
    if len(argv) <= 1:
        _usage()
        return 1

    raw_command = " ".join(argv[1:]).strip()
    if not raw_command:
        _usage()
        return 1

    try:
        data, pane_id = _resolve_session()
        backend = get_backend_for_session(data)
        if not backend:
            raise RuntimeError("❌ 无法初始化终端后端")
        if not backend.is_alive(pane_id):
            terminal = data.get("terminal", "tmux")
            raise RuntimeError(f"❌ {terminal} 会话不存在: {pane_id}\n提示: 请确认 ccb 正在运行")
        backend.send_text(pane_id, raw_command)
        print(f"✅ 已发送到 Codex ({pane_id})")
        return 0
    except Exception as exc:
        print(exc, file=sys.stderr)
        return 1


if __name__ == "__main__":
    raise SystemExit(main(sys.argv))
