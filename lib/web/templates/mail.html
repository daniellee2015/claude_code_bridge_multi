{% extends "base.html" %}

{% block content %}
<div x-data="mailConfigApp()" x-init="init()" class="space-y-6">
    <!-- Status Card -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Mail Service Status</h3>
            <div class="grid grid-cols-2 gap-4 sm:grid-cols-4">
                <div class="text-center">
                    <p class="text-sm text-gray-500">Configured</p>
                    <p class="text-lg font-medium" :class="status.configured ? 'text-green-600' : 'text-red-600'"
                        x-text="status.configured ? 'Yes' : 'No'"></p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500">Enabled</p>
                    <p class="text-lg font-medium" :class="status.enabled ? 'text-green-600' : 'text-gray-600'"
                        x-text="status.enabled ? 'Yes' : 'No'"></p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500">Daemon</p>
                    <p class="text-lg font-medium" :class="status.daemon_running ? 'text-green-600' : 'text-red-600'"
                        x-text="status.daemon_running ? 'Running' : 'Stopped'"></p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-gray-500">Account</p>
                    <p class="text-lg font-medium text-gray-900" x-text="status.email || '-'"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Form -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Configuration</h3>

            <form @submit.prevent="saveConfig()" class="space-y-4">
                <!-- Provider -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email Provider</label>
                    <select x-model="config.provider"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="gmail">Gmail</option>
                        <option value="outlook">Outlook / Microsoft 365</option>
                        <option value="qq">QQ 邮箱</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>

                <!-- Email -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" x-model="config.email" required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        placeholder="your@email.com">
                </div>

                <!-- Password -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">App Password</label>
                    <input type="password" x-model="config.password"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        placeholder="Leave empty to keep existing">
                    <p class="mt-1 text-xs text-gray-500">Use an app-specific password, not your regular password</p>
                </div>

                <!-- Routing Mode -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Routing Mode</label>
                    <select x-model="config.routing_mode"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="plus_alias">Plus-alias (user+claude@gmail.com)</option>
                        <option value="subject_prefix">Subject prefix ([claude] message)</option>
                    </select>
                </div>

                <!-- Default Provider -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Default AI Provider</label>
                    <select x-model="config.default_provider"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        <option value="claude">Claude</option>
                        <option value="codex">Codex</option>
                        <option value="gemini">Gemini</option>
                        <option value="opencode">OpenCode</option>
                        <option value="droid">Droid</option>
                    </select>
                </div>

                <!-- Polling Interval -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Polling Interval (seconds)</label>
                    <input type="number" x-model.number="config.polling_interval" min="10" max="300"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>

                <!-- Enabled -->
                <div class="flex items-center">
                    <input type="checkbox" x-model="config.enabled" id="enabled"
                        class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="enabled" class="ml-2 block text-sm text-gray-900">Enable mail service</label>
                </div>

                <!-- Buttons -->
                <div class="flex space-x-3 pt-4">
                    <button type="submit" :disabled="saving"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50">
                        <span x-show="!saving">Save Configuration</span>
                        <span x-show="saving">Saving...</span>
                    </button>
                    <button type="button" @click="testConnection()" :disabled="testing"
                        class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:opacity-50">
                        <span x-show="!testing">Test Connection</span>
                        <span x-show="testing">Testing...</span>
                    </button>
                    <button type="button" @click="sendTestEmail()" :disabled="sendingTest"
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50">
                        <span x-show="!sendingTest">Send Test Email</span>
                        <span x-show="sendingTest">Sending...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Results -->
    <div x-show="testResult" x-cloak class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Connection Test Results</h3>
            <div class="space-y-2">
                <div class="flex items-center">
                    <span class="status-dot" :class="testResult?.imap_ok ? 'status-running' : 'status-stopped'"></span>
                    <span class="ml-2">IMAP: <span x-text="testResult?.imap_message"></span></span>
                </div>
                <div class="flex items-center">
                    <span class="status-dot" :class="testResult?.smtp_ok ? 'status-running' : 'status-stopped'"></span>
                    <span class="ml-2">SMTP: <span x-text="testResult?.smtp_message"></span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div x-show="notification" x-cloak
        class="fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg"
        :class="notification?.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'">
        <span x-text="notification?.message"></span>
    </div>
</div>

<script>
function mailConfigApp() {
    return {
        status: { configured: false, enabled: false, daemon_running: false, email: null },
        config: {
            provider: 'gmail',
            email: '',
            password: '',
            routing_mode: 'plus_alias',
            default_provider: 'claude',
            polling_interval: 30,
            enabled: false
        },
        testResult: null,
        saving: false,
        testing: false,
        sendingTest: false,
        notification: null,

        async init() {
            await this.fetchStatus();
            await this.fetchConfig();
        },

        async fetchStatus() {
            try {
                const res = await fetch('/api/mail/status');
                this.status = await res.json();
            } catch (e) {
                console.error('Failed to fetch status:', e);
            }
        },

        async fetchConfig() {
            try {
                const res = await fetch('/api/mail/config');
                const data = await res.json();
                this.config = { ...this.config, ...data, password: '' };
            } catch (e) {
                console.error('Failed to fetch config:', e);
            }
        },

        async saveConfig() {
            this.saving = true;
            try {
                const payload = { ...this.config };
                if (!payload.password) delete payload.password;

                const res = await fetch('/api/mail/config', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    this.showNotification('success', 'Configuration saved');
                    await this.fetchStatus();
                } else {
                    const err = await res.json();
                    this.showNotification('error', err.detail || 'Failed to save');
                }
            } catch (e) {
                this.showNotification('error', 'Failed to save configuration');
            }
            this.saving = false;
        },

        async testConnection() {
            this.testing = true;
            this.testResult = null;
            try {
                const res = await fetch('/api/mail/test', { method: 'POST' });
                this.testResult = await res.json();
                if (this.testResult.success) {
                    this.showNotification('success', 'Connection test passed');
                } else {
                    this.showNotification('error', 'Connection test failed');
                }
            } catch (e) {
                this.showNotification('error', 'Failed to test connection');
            }
            this.testing = false;
        },

        async sendTestEmail() {
            this.sendingTest = true;
            try {
                const res = await fetch('/api/mail/send-test', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    this.showNotification('success', 'Test email sent');
                } else {
                    this.showNotification('error', data.message);
                }
            } catch (e) {
                this.showNotification('error', 'Failed to send test email');
            }
            this.sendingTest = false;
        },

        showNotification(type, message) {
            this.notification = { type, message };
            setTimeout(() => { this.notification = null; }, 3000);
        }
    };
}
</script>
{% endblock %}
