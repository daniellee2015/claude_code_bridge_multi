{% extends "base.html" %}

{% block content %}
<div x-data="dashboardApp()" x-init="init()" class="space-y-6">
    <!-- Daemons Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Daemons</h3>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <!-- askd -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="status-dot" :class="daemons.askd.running ? 'status-running' : 'status-stopped'"></span>
                            <span class="ml-2 font-medium">askd</span>
                        </div>
                        <span class="text-sm text-gray-500" x-text="daemons.askd.running ? 'Running' : 'Stopped'"></span>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button @click="startDaemon('askd')" :disabled="daemons.askd.running || loading.askd"
                            class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50">
                            Start
                        </button>
                        <button @click="stopDaemon('askd')" :disabled="!daemons.askd.running || loading.askd"
                            class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50">
                            Stop
                        </button>
                    </div>
                </div>

                <!-- maild -->
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="status-dot" :class="daemons.maild.running ? 'status-running' : 'status-stopped'"></span>
                            <span class="ml-2 font-medium">maild</span>
                        </div>
                        <span class="text-sm text-gray-500" x-text="daemons.maild.running ? 'Running' : 'Stopped'"></span>
                    </div>
                    <div class="mt-3 flex space-x-2">
                        <button @click="startDaemon('maild')" :disabled="daemons.maild.running || loading.maild"
                            class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50">
                            Start
                        </button>
                        <button @click="stopDaemon('maild')" :disabled="!daemons.maild.running || loading.maild"
                            class="px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 disabled:opacity-50">
                            Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Providers Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Providers</h3>
            <div class="grid grid-cols-2 gap-4 sm:grid-cols-5">
                <template x-for="provider in providers" :key="provider.name">
                    <div class="border rounded-lg p-3 text-center">
                        <div class="flex items-center justify-center">
                            <span class="status-dot" :class="provider.available ? 'status-running' : 'status-stopped'"></span>
                            <span class="ml-2 font-medium" x-text="provider.name"></span>
                        </div>
                        <button @click="pingProvider(provider.name)" :disabled="loading[provider.name]"
                            class="mt-2 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50">
                            Ping
                        </button>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Mail Service Section -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Mail Service</h3>
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">
                        Status: <span class="font-medium" x-text="mailStatus.daemon_running ? 'Running' : 'Stopped'"></span>
                    </p>
                    <p class="text-sm text-gray-500" x-show="mailStatus.email">
                        Account: <span class="font-medium" x-text="mailStatus.email"></span>
                    </p>
                </div>
                <div class="flex space-x-2">
                    <a href="/mail" class="px-3 py-1 text-sm bg-gray-500 text-white rounded hover:bg-gray-600">
                        Configure
                    </a>
                    <button @click="testMail()" :disabled="!mailStatus.configured || loading.mail"
                        class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50">
                        Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div x-show="notification" x-cloak
        class="fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg"
        :class="notification?.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'">
        <span x-text="notification?.message"></span>
    </div>
</div>

<script>
function dashboardApp() {
    return {
        daemons: {
            askd: { running: false, pid: null },
            maild: { running: false, pid: null }
        },
        providers: [],
        mailStatus: { configured: false, enabled: false, daemon_running: false, email: null },
        loading: {},
        notification: null,

        async init() {
            await this.fetchDaemons();
            await this.fetchProviders();
            await this.fetchMailStatus();

            // Listen for WebSocket updates
            window.addEventListener('ccb-status', (e) => {
                if (e.detail.daemons) {
                    this.daemons = e.detail.daemons;
                }
            });
        },

        async fetchDaemons() {
            try {
                const res = await fetch('/api/daemons');
                const data = await res.json();
                data.forEach(d => {
                    this.daemons[d.name] = d;
                });
            } catch (e) {
                console.error('Failed to fetch daemons:', e);
            }
        },

        async fetchProviders() {
            try {
                const res = await fetch('/api/providers');
                this.providers = await res.json();
            } catch (e) {
                console.error('Failed to fetch providers:', e);
            }
        },

        async fetchMailStatus() {
            try {
                const res = await fetch('/api/mail/status');
                this.mailStatus = await res.json();
            } catch (e) {
                console.error('Failed to fetch mail status:', e);
            }
        },

        async startDaemon(name) {
            this.loading[name] = true;
            try {
                const res = await fetch(`/api/daemons/${name}/start`, { method: 'POST' });
                const data = await res.json();
                this.showNotification(data.success ? 'success' : 'error', data.message);
                await this.fetchDaemons();
            } catch (e) {
                this.showNotification('error', `Failed to start ${name}`);
            }
            this.loading[name] = false;
        },

        async stopDaemon(name) {
            this.loading[name] = true;
            try {
                const res = await fetch(`/api/daemons/${name}/stop`, { method: 'POST' });
                const data = await res.json();
                this.showNotification(data.success ? 'success' : 'error', data.message);
                await this.fetchDaemons();
            } catch (e) {
                this.showNotification('error', `Failed to stop ${name}`);
            }
            this.loading[name] = false;
        },

        async pingProvider(name) {
            this.loading[name] = true;
            try {
                const res = await fetch(`/api/providers/${name}/ping`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    this.showNotification('success', `${name}: ${data.latency_ms?.toFixed(0)}ms`);
                } else {
                    this.showNotification('error', `${name}: ${data.error}`);
                }
            } catch (e) {
                this.showNotification('error', `Failed to ping ${name}`);
            }
            this.loading[name] = false;
        },

        async testMail() {
            this.loading.mail = true;
            try {
                const res = await fetch('/api/mail/test', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    this.showNotification('success', 'Mail connection OK');
                } else {
                    this.showNotification('error', `IMAP: ${data.imap_message}, SMTP: ${data.smtp_message}`);
                }
            } catch (e) {
                this.showNotification('error', 'Failed to test mail');
            }
            this.loading.mail = false;
        },

        showNotification(type, message) {
            this.notification = { type, message };
            setTimeout(() => { this.notification = null; }, 3000);
        }
    };
}
</script>
{% endblock %}
