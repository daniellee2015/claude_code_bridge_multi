# =============================================================================
# CCB (Claude Code Bridge) tmux configuration
# Compatible with Oh My Tmux (gpakosz/.tmux)
# Auto-installed by ccb install.sh
# =============================================================================

# -----------------------------------------------------------------------------
# General Settings
# -----------------------------------------------------------------------------

# Enable mouse support (click to switch pane, scroll, drag to resize)
set -g mouse on

# Use vi mode for copy mode
set-window-option -g mode-keys vi

# Larger history buffer
set -g history-limit 50000

# Faster escape time (better for vim/neovim)
set -sg escape-time 10

# Focus events for vim/neovim autoread
set -g focus-events on

# Enable system clipboard integration (OSC 52)
set -s set-clipboard on

# Ensure clipboard-related env vars stay updated when attaching from GUI/remote sessions.
# (Important on Wayland/WSL, and when tmux server was started without DISPLAY.)
set -g update-environment "DISPLAY WAYLAND_DISPLAY XDG_RUNTIME_DIR WSL_DISTRO_NAME WSL_INTEROP SSH_AUTH_SOCK SSH_CONNECTION"

# Better colors
set -g default-terminal "tmux-256color"
set -sa terminal-features ',xterm-256color:RGB'
set -sa terminal-overrides ',xterm-256color:Tc'

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# NOTE:
# CCB's status bar + pane title theming is enabled only while CCB is running.
# See: `@CCB_BIN_DIR@/ccb-tmux-on.sh` / `@CCB_BIN_DIR@/ccb-tmux-off.sh`.

# CCB script directory (filled by installer)
set -g @ccb_bin_dir "@CCB_BIN_DIR@"

# -----------------------------------------------------------------------------
# Copy Mode (vi-style) with System Clipboard
# -----------------------------------------------------------------------------

# Better scroll speed (2 lines per scroll instead of default 5)
bind -T copy-mode-vi WheelUpPane select-pane \; send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 2 scroll-down

# Vi-style copy mode bindings
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'C-v' send -X rectangle-toggle

# Copy to system clipboard (auto-detect by tool presence).
# 'y' to copy and stay in copy mode, 'Enter' to copy and exit.
if-shell 'command -v xclip' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe 'xclip -selection clipboard'
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'xclip -selection clipboard'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xclip -selection clipboard'
}
if-shell 'command -v xsel' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe 'xsel --clipboard --input'
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'xsel --clipboard --input'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'xsel --clipboard --input'
}
if-shell 'command -v wl-copy' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe 'wl-copy'
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'wl-copy'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'wl-copy'
}
if-shell 'command -v pbcopy' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe 'pbcopy'
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel 'pbcopy'
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel 'pbcopy'
}
# Prefer PowerShell clipboard providers when available (more reliable UTF-8 handling on WSL/Windows).
if-shell 'command -v powershell.exe >/dev/null 2>&1' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe "powershell.exe -NoProfile -Command '[Console]::InputEncoding=[System.Text.UTF8Encoding]::new(); Set-Clipboard -Value ([Console]::In.ReadToEnd())'"
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "powershell.exe -NoProfile -Command '[Console]::InputEncoding=[System.Text.UTF8Encoding]::new(); Set-Clipboard -Value ([Console]::In.ReadToEnd())'"
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "powershell.exe -NoProfile -Command '[Console]::InputEncoding=[System.Text.UTF8Encoding]::new(); Set-Clipboard -Value ([Console]::In.ReadToEnd())'"
}
if-shell 'command -v pwsh >/dev/null 2>&1' {
    bind-key -T copy-mode-vi 'y' send -X copy-pipe "pwsh -NoLogo -NoProfile -Command '[Console]::InputEncoding=[System.Text.UTF8Encoding]::new(); Set-Clipboard -Value ([Console]::In.ReadToEnd())'"
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pwsh -NoLogo -NoProfile -Command '[Console]::InputEncoding=[System.Text.UTF8Encoding]::new(); Set-Clipboard -Value ([Console]::In.ReadToEnd())'"
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "pwsh -NoLogo -NoProfile -Command '[Console]::InputEncoding=[System.Text.UTF8Encoding]::new(); Set-Clipboard -Value ([Console]::In.ReadToEnd())'"
}

# Paste from system clipboard (try providers in order; avoids X11/Wayland mis-detection).
# Prefer tmux's default paste key (`prefix + ]`) for compatibility with common tmux configs.
# Also bind `prefix + p` because many users expect it (and some configs remap `]`).
bind-key ] run-shell "sh -lc '\
out=\"\"; \
if [ -z \"\$out\" ] && command -v pwsh >/dev/null 2>&1; then out=$(pwsh -NoLogo -NoProfile -Command '\''[Console]::OutputEncoding=[System.Text.UTF8Encoding]::new(); Get-Clipboard'\'' 2>/dev/null | tr -d \"\\r\" || true); fi; \
if [ -z \"\$out\" ] && command -v powershell.exe >/dev/null 2>&1; then out=$(powershell.exe -NoProfile -Command '\''[Console]::OutputEncoding=[System.Text.UTF8Encoding]::new(); Get-Clipboard'\'' 2>/dev/null | tr -d \"\\r\" || true); fi; \
if [ -z \"\$out\" ] && command -v wl-paste >/dev/null 2>&1; then out=$(wl-paste -n 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v wl-paste >/dev/null 2>&1; then out=$(wl-paste -n -p 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xclip >/dev/null 2>&1; then out=$(xclip -selection clipboard -o 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xclip >/dev/null 2>&1; then out=$(xclip -selection primary -o 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xsel >/dev/null 2>&1; then out=$(xsel --clipboard --output 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xsel >/dev/null 2>&1; then out=$(xsel --primary --output 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v pbpaste >/dev/null 2>&1; then out=$(pbpaste 2>/dev/null || true); fi; \
if [ -z \"\$out\" ]; then tmux display-message \"No clipboard content/helper found (install wl-clipboard or xclip/xsel)\"; exit 0; fi; \
printf \"%s\" \"\$out\"' | tmux load-buffer - && tmux paste-buffer"
bind-key p run-shell "sh -lc '\
out=\"\"; \
if [ -z \"\$out\" ] && command -v pwsh >/dev/null 2>&1; then out=$(pwsh -NoLogo -NoProfile -Command '\''[Console]::OutputEncoding=[System.Text.UTF8Encoding]::new(); Get-Clipboard'\'' 2>/dev/null | tr -d \"\\r\" || true); fi; \
if [ -z \"\$out\" ] && command -v powershell.exe >/dev/null 2>&1; then out=$(powershell.exe -NoProfile -Command '\''[Console]::OutputEncoding=[System.Text.UTF8Encoding]::new(); Get-Clipboard'\'' 2>/dev/null | tr -d \"\\r\" || true); fi; \
if [ -z \"\$out\" ] && command -v wl-paste >/dev/null 2>&1; then out=$(wl-paste -n 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v wl-paste >/dev/null 2>&1; then out=$(wl-paste -n -p 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xclip >/dev/null 2>&1; then out=$(xclip -selection clipboard -o 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xclip >/dev/null 2>&1; then out=$(xclip -selection primary -o 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xsel >/dev/null 2>&1; then out=$(xsel --clipboard --output 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v xsel >/dev/null 2>&1; then out=$(xsel --primary --output 2>/dev/null || true); fi; \
if [ -z \"\$out\" ] && command -v pbpaste >/dev/null 2>&1; then out=$(pbpaste 2>/dev/null || true); fi; \
if [ -z \"\$out\" ]; then tmux display-message \"No clipboard content/helper found (install wl-clipboard or xclip/xsel)\"; exit 0; fi; \
printf \"%s\" \"\$out\"' | tmux load-buffer - && tmux paste-buffer"

# Alternative: paste the PRIMARY selection when available (useful on Linux where middle-click works).
bind-key P run-shell "sh -lc 'if command -v wl-paste >/dev/null 2>&1 && wl-paste -n -p 2>/dev/null; then exit 0; fi; if command -v xclip >/dev/null 2>&1 && xclip -selection primary -o 2>/dev/null; then exit 0; fi; if command -v xsel >/dev/null 2>&1 && xsel --primary --output 2>/dev/null; then exit 0; fi; tmux display-message \"No PRIMARY selection helper found\"; exit 0' | tmux load-buffer - && tmux paste-buffer"

# (CCB theme is applied dynamically by ccb while running.)

# NOTE:
# We intentionally do NOT bind model-specific tmux keys (e.g. prefix+o/c/g),
# because they conflict with common tmux defaults and user workflows.
# If you want CCB navigation keys, add your own bindings in `~/.tmux.conf.local`.

# -----------------------------------------------------------------------------
# Pane Management
# -----------------------------------------------------------------------------

# Split panes using | and -
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Navigate panes with vim keys
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Resize panes with Shift + vim keys
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Zoom pane toggle
bind z resize-pane -Z

# Synchronize panes toggle (type in all panes)
bind S setw synchronize-panes

# -----------------------------------------------------------------------------
# Mouse Mode Toggle
# -----------------------------------------------------------------------------

bind m set -g mouse on \; display "Mouse ON"
bind M set -g mouse off \; display "Mouse OFF"

# -----------------------------------------------------------------------------
# Reload Config
# -----------------------------------------------------------------------------

bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# -----------------------------------------------------------------------------
# Session Management
# -----------------------------------------------------------------------------

# Easy session switching
bind s choose-tree -Zs

# Kill session
bind X confirm-before -p "Kill session #S? (y/n)" kill-session

# -----------------------------------------------------------------------------
# Activity Monitoring
# -----------------------------------------------------------------------------

setw -g monitor-activity on
set -g visual-activity off

# -----------------------------------------------------------------------------
# Visual Styling / Theme
# -----------------------------------------------------------------------------
# NOTE:
# CCB intentionally does not set any persistent statusbar/theme options here.
# The CCB theme is applied per-session only while CCB is active via:
#   - `~/.local/bin/ccb-tmux-on.sh`
# and restored on exit via:
#   - `~/.local/bin/ccb-tmux-off.sh`
#
# This avoids clobbering your existing tmux theme when CCB is not running.

# =============================================================================
# End of CCB tmux configuration
# =============================================================================
